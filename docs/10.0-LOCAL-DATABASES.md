# 10.0 LOCAL DATABASES

This document describes the **local persistence** used by the Device Owner app: Room databases, main entities, and their roles.

---

## Overview

The app uses **Room** for structured local storage. The primary database is **DeviceOwnerDatabase**, used for offline queue, registration data, heartbeat history, tamper events, lock state records, and SIM change history. A separate **AppDatabase** may exist for optional analytics or history.

---

## DeviceOwnerDatabase

**Class**: `com.microspace.payo.data.local.database.DeviceOwnerDatabase`  
**Database name**: `device_owner_database`  
**Version**: 11 (with `fallbackToDestructiveMigration()`)

### Role

- Single source of truth for **sync/queue** and operational data.  
- Used by **OfflineSyncWorker**, heartbeat offline logic, tamper persistence, lock state history, and SIM change history.

### Entities and DAOs

| Entity | DAO | Purpose |
|--------|-----|---------|
| **DeviceRegistrationEntity** | DeviceRegistrationDao | Device registration records |
| **CompleteDeviceRegistrationEntity** | CompleteDeviceRegistrationDao | Full registration payload / history |
| **DeviceDataEntity** | DeviceDataDao | Device data snapshots |
| **HeartbeatEntity** | HeartbeatDao | Heartbeat send history / cache |
| **HeartbeatHistoryEntity** | HeartbeatHistoryDao | Historical heartbeat data |
| **TamperDetectionEntity** | TamperDetectionDao | Tamper events (for sync and history) |
| **DeviceBaselineEntity** | DeviceBaselineDao | Baseline device state (e.g. for comparison) |
| **OfflineEvent** | OfflineEventDao | Offline queue: events to send when network is available (e.g. tamper, logs) |
| **SimChangeHistoryEntity** | SimChangeHistoryDao | SIM change events |
| **LockStateRecordEntity** | LockStateRecordDao | Lock state history (hard/soft lock events) |

### Access

- **DeviceOwnerDatabase.getDatabase(context)** â€” singleton instance.  
- Used by: **HeartbeatWorker**, **OfflineSyncWorker**, **EnhancedAntiTamperResponse**, **RemoteDeviceControlManager** (lock state records), SIM change flow, and any component that needs to read/write offline events or history.

---

## Offline event queue

- **OfflineEvent** and **OfflineEventDao** store events that could not be sent while offline (e.g. tamper report, device log).  
- **OfflineSyncWorker** (triggered when network becomes available) processes the queue and sends events to the backend, then clears or marks them as synced.

---

## AppDatabase (optional)

- If present, **AppDatabase** is used for optional analytics or non-critical history.  
- Operational sync and lock/tamper/heartbeat rely on **DeviceOwnerDatabase**, not AppDatabase.

---

## SharedPreferences (complement)

Besides Room, the app uses **SharedPreferences** for:

- **device_registration** â€” device_id, loan number  
- **device_data** â€” device_id_for_heartbeat  
- **device_owner_config** â€” security mode, etc.  
- **control_prefs** â€” lock state, reason, timestamp (and device-protected copy for boot)  
- **device_locks** (HardLockManager) â€” lock_type, lock_reason, lock_timestamp, lock_source  

These are the â€œliveâ€ settings; Room is used for queue and history.

---

## Summary

| Item | Description |
|------|-------------|
| Main DB | DeviceOwnerDatabase (Room, version 11) |
| Entities | Registration, DeviceData, Heartbeat, HeartbeatHistory, TamperDetection, DeviceBaseline, OfflineEvent, SimChangeHistory, LockStateRecord |
| Offline queue | OfflineEvent + OfflineEventDao; synced by OfflineSyncWorker |
| Lock state | LockStateRecordEntity for history; current state in SharedPreferences |

Related: [7.0 Device Heartbeat](7.0-DEVICE-HEARTBEAT.md), [9.0 Device Tamper](9.0-DEVICE-TAMPER.md), [8.0 Hard Lock and Soft Lock](8.0-HARD-LOCK-AND-SOFT-LOCK.md).


