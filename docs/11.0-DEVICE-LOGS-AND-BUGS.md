# 11.0 DEVICE LOGS AND BUGS

This document describes how the app **logs** events locally, sends **device logs** to the backend, and reports **bugs** (including uncaught exceptions) to the tech API.

---

## Overview

- **Logs**: Categorized local log files (e.g. registration, heartbeat, security) and optional **remote** posting of log entries (Error/Warning) to the backend tech API.  
- **Bugs**: Explicit bug reports and **uncaught exceptions** sent to the backend for debugging and support.  
- **Initialization**: **LogManager.initialize(context)** and **ServerBugAndLogReporter.init(context)** are called from **DeviceOwnerApplication.onCreate()**; the remote log callback is set so that Error/Warning logs are also posted to the server.

---

## LogManager (local and remote)

**Class**: `com.example.deviceowner.utils.logging.LogManager`

### Log categories

Logs are organized by **LogCategory** (each has a folder and file name under `DeviceOwnerLogs/`):

| Category | Folder | File (example) |
|----------|--------|------------------|
| DEVICE_REGISTRATION | registration | device_registration |
| DEVICE_OWNER | device_owner | device_owner_operations |
| API_CALLS | api | api_requests_responses |
| DEVICE_INFO | device_info | device_information |
| HEARTBEAT | heartbeat | heartbeat_service |
| SECURITY | security | security_monitoring |
| PROVISIONING | provisioning | device_provisioning |
| SYNC | sync | offline_sync |
| ERRORS | errors | application_errors |
| GENERAL | general | general_logs |
| JSON_LOGS | json_logs | raw_json_data |

### Storage

- **Base directory**: `getExternalFilesDir(null)/DeviceOwnerLogs/`.  
- Under it, one subfolder per category; daily or category-specific log files are written there.  
- **LogManager** provides methods such as **logInfo**, **logWarning**, **logError** with category and message.

### Remote log callback

- **setOnRemoteLogCallback(callback)** — Set from **DeviceOwnerApplication** after **LogManager.initialize()**.  
- When a log is written at **Error** or **Warning** level, the callback is invoked. The app wires it to **ServerBugAndLogReporter.postLog()** so those entries are also sent to the backend.  
- Callback signature: `(LogCategory, logLevel, message, extraData?) -> Unit`.

---

## ServerBugAndLogReporter (remote logs and bugs)

**Class**: `com.example.deviceowner.services.reporting.ServerBugAndLogReporter`

### Initialization

- **init(context)** — Call from **Application.onCreate()** so the reporter can resolve the device ID. If not called, posting still works but uses a fallback device id (e.g. `UNREGISTERED-{model}`).

### Device ID resolution

- **getDeviceId()** uses **SharedPreferencesManager.getDeviceIdForHeartbeat()**, then `device_registration.device_id`, then `device_data.device_id_for_heartbeat`. If none, returns `UNREGISTERED-{manufacturer}-{model}` or similar.

### Log posting (device logs)

- **postLog(logType, logLevel, message, extraData)**  
  - Builds **DeviceLogRequest** (deviceId, logType, message, logLevel, extraData).  
  - Calls **ApiClient.postDeviceLog(body)**.  
  - **Endpoint**: `POST api/tech/devicecategory/logs/`.  
  - Fire-and-forget; never throws. Message length is truncated (e.g. MAX_MESSAGE_LENGTH 8000).

**Category mapping (app → backend LogType)**:

- DEVICE_REGISTRATION → `registration`  
- HEARTBEAT → `heartbeat`  
- API_CALLS → `system`  
- SECURITY → `security`  
- PROVISIONING → `installation`  
- SYNC → `data_sync`  
- ERRORS / GENERAL → `error`  
- DEVICE_OWNER / DEVICE_INFO / JSON_LOGS → `system`  
- Else → `other`

**Level mapping**: ERROR → `Error`, WARN/WARNING → `Warning`, else → `Normal`.

### Bug posting

- **postBug(title, message, deviceInfo?, priority?, extraData?)**  
  - Builds **BugReportRequest** and calls **ApiClient** (e.g. **postBugReport** or equivalent).  
  - **Endpoint**: `POST api/tech/devicecategory/bugs/`.  
  - Title/message truncated (e.g. MAX_TITLE_LENGTH 250, MAX_MESSAGE_LENGTH 8000).  
  - Fire-and-forget.

- **postException(throwable, contextMessage?)**  
  - Serializes the exception (stack trace, message) and calls **postBug()** with a suitable title and message (e.g. “Uncaught exception in {thread}”).  
  - Used by the **global uncaught exception handler** in **DeviceOwnerApplication.setupGlobalExceptionHandler()**.

---

## Global exception handler

In **DeviceOwnerApplication**:

- **Thread.setDefaultUncaughtExceptionHandler** is set to:
  - Log the exception.  
  - Call **ServerBugAndLogReporter.postException(throwable, ...)** so the backend receives it.  
  - For **background** threads (e.g. DefaultDispatcher, Worker, pool), the handler may not rethrow so the process can continue.  
  - For the **main** thread, the default handler is invoked so the app can crash or show an error as configured.

This ensures uncaught exceptions are both logged and reported as bugs to the tech API.

---

## API endpoints (tech)

| Purpose | Endpoint | Model |
|---------|----------|--------|
| Device logs | POST api/tech/devicecategory/logs/ | DeviceLogRequest |
| Bug reports | POST api/tech/devicecategory/bugs/ | BugReportRequest |

Defined in **ApiEndpoints** (`DEVICE_LOGS`, `BUG_REPORTS`) and implemented in **ApiClient** and **ApiService**.

---

## Summary

| Topic | Detail |
|-------|--------|
| Local logs | LogManager; categories (registration, heartbeat, security, etc.); files under DeviceOwnerLogs/ |
| Remote logs | ServerBugAndLogReporter.postLog(); callback from LogManager for Error/Warning |
| Log API | POST api/tech/devicecategory/logs/ |
| Bug API | POST api/tech/devicecategory/bugs/ |
| Exceptions | postException() + global uncaught exception handler in Application |
| Init | LogManager.initialize(); ServerBugAndLogReporter.init(); setOnRemoteLogCallback() in Application |

For **tamper** (which may be logged and reported), see [9.0 Device Tamper](9.0-DEVICE-TAMPER.md). For **folder layout** of the project, see [14.0 Folder Structure](14.0-FOLDER-STRUCTURE.md).
