# 15.0 FACTORY RESET PROTECTION (FRP)

This document describes **Enterprise Factory Reset Protection (FRP)** in the Device Owner app.

---

## Overview

| Aspect | Description |
|--------|-------------|
| **Purpose** | After factory reset, only the **company Google account** can unlock the device. |
| **Mechanism** | Android FRP with Google servers; app sets FRP policy with company account ID. |
| **Activation** | **72 hours** after FRP is applied (Google requirement). |
| **Minimum Android** | API 30 (Android 11). |

---

## Configuration (FrpConfig.kt)

- **COMPANY_FRP_ACCOUNT_ID**: Company Google account obfuscated Gaia ID (21 digits).
- **BACKUP_FRP_ACCOUNTS**: Optional backup account IDs.
- **FRP_ACTIVATION_HOURS**: 72.
- **GMS**: Google Play Services; broadcast **FRP_CONFIG_CHANGED** notifies GMS after policy is set.

---

## When FRP is set up

- **AdminReceiver**: On becoming Device Owner, calls **FrpManager(context).setupFrpProtection()**.
- **DeviceDataCollector**: Uses **FrpManager(context).getFrpStatus()** for device/registration data.

---

## FrpManager (core/frp/FrpManager.kt)

- **setupFrpProtection()**: Validates Device Owner, GMS, account ID; builds and applies **FactoryResetProtectionPolicy**; notifies GMS; records activation time. Returns **FrpResult**.
- **getFrpStatus()**: Returns **FrpStatus** (enabled, fullyActivated, accountId, activationTime, hoursRemaining, gmsAvailable).
- **isFrpFullyActivated()**: True after 72 hours.
- **getHoursUntilActivation()**: Hours left until full activation.
- **verifyFrpPolicy()**: Checks FRP enabled and GMS available.

Preconditions: app is Device Owner, GMS available, valid account ID, Android 11+.

---

## FrpStatus (data class)

- enabled, fullyActivated, accountId, activationTime, hoursRemaining, gmsAvailable.

---

## UI (FrpStatusActivity)

- **ui.activities.status.FrpStatusActivity**: Opened from MainActivity "FRP Protection" card.
- Shows: FRP on/off, 72-hour status (fully activated or X hours remaining), company account (obfuscated), GMS availability.

---

## Related components

- **FrpConfig**: Account IDs, timing, prefs keys.
- **FrpManager**: Apply policy and status.
- **FrpPolicyManager**, **FrpVerificationService**, **FrpHealthCheckService**: Policy and verification if used.
- **AdminReceiver**: Calls setupFrpProtection() when becoming Device Owner.
