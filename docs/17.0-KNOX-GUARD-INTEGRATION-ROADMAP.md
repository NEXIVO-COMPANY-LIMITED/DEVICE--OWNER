# 17.0 SAMSUNG KNOX GUARD INTEGRATION ROADMAP
## Adding Enterprise-Grade Security to Your Device Owner App

**Current State**: Strong Device Owner foundation with comprehensive features  
**Target State**: Device Owner + Knox Guard = Watu Simu/Easybuy level protection

---

# üìã EXECUTIVE SUMMARY

This roadmap shows you how to integrate Samsung Knox Guard into your existing Device Owner app to achieve **Watu Simu-level** device security and management.

**Timeline**: 3-6 months  
**Cost**: ~$3,650/year for 1,000 devices  
**Result**: 70% ‚Üí 90% protection level

---

# üéØ INTEGRATION STRATEGY

## Your Current Device Owner App Strengths:

‚úÖ QR Code provisioning  
‚úÖ 30-second heartbeat monitoring  
‚úÖ Hard/Soft lock mechanisms  
‚úÖ Tamper detection  
‚úÖ Backend integration  
‚úÖ Auto-updates  

## What Knox Guard Adds:

‚úÖ Hardware-backed security (TEE/StrongBox)  
‚úÖ Survives factory reset  
‚úÖ Firmware-level protection  
‚úÖ Samsung ecosystem support  
‚úÖ Professional-grade reliability  

## Combined Architecture:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       SAMSUNG KNOX GUARD (Layer 1)         ‚îÇ
‚îÇ  ‚Ä¢ Hardware-backed lock/unlock             ‚îÇ
‚îÇ  ‚Ä¢ Firmware-level protection               ‚îÇ
‚îÇ  ‚Ä¢ Factory reset survival                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       YOUR DEVICE OWNER APP (Layer 2)      ‚îÇ
‚îÇ  ‚Ä¢ Business logic & custom features        ‚îÇ
‚îÇ  ‚Ä¢ Heartbeat monitoring                    ‚îÇ
‚îÇ  ‚Ä¢ Tamper detection                        ‚îÇ
‚îÇ  ‚Ä¢ Payment tracking                        ‚îÇ
‚îÇ  ‚Ä¢ Multi-brand support                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         YOUR BACKEND (Layer 3)             ‚îÇ
‚îÇ  ‚Ä¢ Knox Guard API integration              ‚îÇ
‚îÇ  ‚Ä¢ Device Owner API                        ‚îÇ
‚îÇ  ‚Ä¢ Payment processing                      ‚îÇ
‚îÇ  ‚Ä¢ Risk scoring                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

# üìÖ PHASE-BY-PHASE IMPLEMENTATION

---

## PHASE 1: PREPARATION & SETUP (Weeks 1-2)

### 1.1 Register for Samsung Knox Guard

**Action Items:**

1. **Create Samsung Account**
   - Visit: https://www.samsungknox.com/
   - Click "Sign Up for Knox Guard"
   - Complete business registration

2. **Submit Business Documentation**
   ```
   Required Documents:
   - Business registration certificate
   - Tax ID/TIN
   - Bank account details
   - Company address proof
   - Contact person details
   ```

3. **Wait for Approval** (5-10 business days)
   - Samsung will review your application
   - May request additional documentation
   - You'll receive Knox Guard portal access

4. **Set Up Billing**
   ```
   Pricing Model:
   - Pay-as-you-go: $0.01/device/day
   - Example: 1,000 devices = $10/day = $300/month = $3,650/year
   - No upfront costs
   - Bill monthly in arrears
   ```

**Deliverables:**
- ‚úÖ Knox Guard account activated
- ‚úÖ Portal access credentials
- ‚úÖ Billing configured
- ‚úÖ API keys generated

---

### 1.2 Understand Knox Guard APIs

**Study These Endpoints:**

```bash
# Knox Guard API Base
https://api.samsungknox.com/kg/v1/

# Key Endpoints:
POST /devices/enroll        # Register device
POST /devices/{id}/lock     # Lock device
POST /devices/{id}/unlock   # Unlock device
GET  /devices/{id}/status   # Check status
POST /devices/bulk-enroll   # Bulk registration
```

**API Authentication:**
```java
// Knox Guard uses OAuth 2.0
String apiKey = "YOUR_KNOX_API_KEY";
String apiSecret = "YOUR_KNOX_API_SECRET";

// Get access token
OkHttpClient client = new OkHttpClient();
Request request = new Request.Builder()
    .url("https://api.samsungknox.com/oauth/token")
    .post(RequestBody.create(
        MediaType.parse("application/json"),
        "{\"grant_type\":\"client_credentials\"," +
        "\"client_id\":\"" + apiKey + "\"," +
        "\"client_secret\":\"" + apiSecret + "\"}"
    ))
    .build();

Response response = client.newCall(request).execute();
String accessToken = parseToken(response.body().string());
```

**Deliverables:**
- ‚úÖ API documentation reviewed
- ‚úÖ Test API calls successful
- ‚úÖ Authentication working

---

### 1.3 Test Device Setup

**Get Test Devices:**

```
Purchase 3-5 Samsung devices for testing:

Recommended Models:
- Samsung Galaxy A05 (Budget: ~$100)
- Samsung Galaxy A13 (Mid: ~$150)
- Samsung Galaxy A23 (Upper: ~$200)

These are NORMAL Samsung phones - no special firmware needed!
```

**Test Environment:**
1. One device for Knox Guard testing
2. One device for Device Owner testing
3. One device for combined testing
4. One device for factory reset testing
5. One device for tamper testing

**Deliverables:**
- ‚úÖ Test devices acquired
- ‚úÖ Test environment set up
- ‚úÖ Knox Guard portal accessible

---

## PHASE 2: BACKEND INTEGRATION (Weeks 3-4)

### 2.1 Knox Guard API Integration

**Backend Architecture:**

```java
// KnoxGuardService.java - New service for Knox integration

@Service
public class KnoxGuardService {
    
    private final String KNOX_API_BASE = "https://api.samsungknox.com/kg/v1/";
    private String accessToken;
    
    // Initialize on startup
    @PostConstruct
    public void init() {
        this.accessToken = authenticateWithKnox();
    }
    
    /**
     * Step 1: Enroll device in Knox Guard
     * Call this when device is registered for loan
     */
    public KnoxEnrollmentResult enrollDevice(String imei, String serialNumber) {
        
        JSONObject enrollmentData = new JSONObject();
        enrollmentData.put("deviceId", imei);
        enrollmentData.put("serialNumber", serialNumber);
        enrollmentData.put("clientId", "YOUR_CLIENT_ID");
        enrollmentData.put("lockMessage", "This device is protected by Knox Guard");
        enrollmentData.put("phoneNumber", "+255700123456"); // Support contact
        
        Request request = new Request.Builder()
            .url(KNOX_API_BASE + "devices/enroll")
            .addHeader("Authorization", "Bearer " + accessToken)
            .post(RequestBody.create(
                MediaType.parse("application/json"),
                enrollmentData.toString()
            ))
            .build();
            
        Response response = client.newCall(request).execute();
        
        if (response.isSuccessful()) {
            KnoxEnrollmentResult result = parseEnrollmentResponse(response.body().string());
            
            // Save Knox enrollment ID to database
            saveKnoxEnrollment(imei, result.getEnrollmentId());
            
            return result;
        } else {
            throw new KnoxEnrollmentException("Failed to enroll device: " + response.message());
        }
    }
    
    /**
     * Step 2: Lock device when payment is late
     * Call this from your payment monitoring system
     */
    public void lockDevice(String imei, String lockReason) {
        
        String enrollmentId = getKnoxEnrollmentId(imei);
        
        JSONObject lockData = new JSONObject();
        lockData.put("message", lockReason);
        lockData.put("allowEmergencyCalls", true);
        lockData.put("phoneNumber", "+255700123456");
        
        Request request = new Request.Builder()
            .url(KNOX_API_BASE + "devices/" + enrollmentId + "/lock")
            .addHeader("Authorization", "Bearer " + accessToken)
            .post(RequestBody.create(
                MediaType.parse("application/json"),
                lockData.toString()
            ))
            .build();
            
        Response response = client.newCall(request).execute();
        
        if (response.isSuccessful()) {
            // Update database
            updateDeviceStatus(imei, "KNOX_LOCKED");
            
            // Log event
            logKnoxAction(imei, "LOCK", lockReason);
        }
    }
    
    /**
     * Step 3: Unlock device when payment received
     */
    public void unlockDevice(String imei, boolean permanent) {
        
        String enrollmentId = getKnoxEnrollmentId(imei);
        
        JSONObject unlockData = new JSONObject();
        unlockData.put("permanent", permanent);
        
        Request request = new Request.Builder()
            .url(KNOX_API_BASE + "devices/" + enrollmentId + "/unlock")
            .addHeader("Authorization", "Bearer " + accessToken)
            .post(RequestBody.create(
                MediaType.parse("application/json"),
                unlockData.toString()
            ))
            .build();
            
        Response response = client.newCall(request).execute();
        
        if (response.isSuccessful()) {
            updateDeviceStatus(imei, permanent ? "KNOX_UNENROLLED" : "KNOX_UNLOCKED");
            
            if (permanent) {
                // Remove from Knox Guard completely
                deleteKnoxEnrollment(imei);
            }
        }
    }
    
    /**
     * Step 4: Check device status
     * Call this periodically to sync with Knox Guard
     */
    public KnoxDeviceStatus getDeviceStatus(String imei) {
        
        String enrollmentId = getKnoxEnrollmentId(imei);
        
        Request request = new Request.Builder()
            .url(KNOX_API_BASE + "devices/" + enrollmentId + "/status")
            .addHeader("Authorization", "Bearer " + accessToken)
            .get()
            .build();
            
        Response response = client.newCall(request).execute();
        
        if (response.isSuccessful()) {
            return parseDeviceStatus(response.body().string());
        }
        
        return null;
    }
}
```

**Database Schema Updates:**

```sql
-- Add Knox Guard tracking table
CREATE TABLE knox_guard_enrollments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id BIGINT NOT NULL,
    imei VARCHAR(20) NOT NULL UNIQUE,
    knox_enrollment_id VARCHAR(100) NOT NULL UNIQUE,
    enrollment_date TIMESTAMP NOT NULL,
    status VARCHAR(50) NOT NULL, -- ENROLLED, LOCKED, UNLOCKED, UNENROLLED
    last_sync TIMESTAMP,
    
    FOREIGN KEY (device_id) REFERENCES devices(id),
    INDEX idx_imei (imei),
    INDEX idx_enrollment_id (knox_enrollment_id)
);

-- Add Knox event log
CREATE TABLE knox_guard_events (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id BIGINT NOT NULL,
    action VARCHAR(50) NOT NULL, -- ENROLL, LOCK, UNLOCK, STATUS_CHECK
    reason TEXT,
    timestamp TIMESTAMP NOT NULL,
    success BOOLEAN NOT NULL,
    error_message TEXT,
    
    FOREIGN KEY (device_id) REFERENCES devices(id),
    INDEX idx_device_timestamp (device_id, timestamp)
);
```

**Deliverables:**
- ‚úÖ Knox Guard API service implemented
- ‚úÖ Database schema updated
- ‚úÖ API calls tested successfully
- ‚úÖ Error handling implemented

---

### 2.2 Payment Integration with Knox Guard

**Integrate Knox with Your Payment System:**

```java
// PaymentService.java - Update existing payment service

@Service
public class PaymentService {
    
    @Autowired
    private KnoxGuardService knoxGuardService;
    
    @Autowired
    private DeviceOwnerCommandService deviceOwnerService;
    
    /**
     * Enhanced payment check - triggers both Device Owner and Knox Guard
     */
    @Scheduled(cron = "0 0 9 * * *") // Every day at 9 AM
    public void checkPaymentStatusAndLockDevices() {
        
        List<Loan> activeLoans = loanRepository.findByStatus("ACTIVE");
        
        for (Loan loan : activeLoans) {
            
            Device device = loan.getDevice();
            PaymentStatus status = calculatePaymentStatus(loan);
            
            // SCENARIO 1: Payment due soon (3 days)
            if (status.dueInDays <= 3 && status.dueInDays > 0) {
                
                // Device Owner: Soft reminder
                deviceOwnerService.sendSoftLock(device.getDeviceId(),
                    "Malipo yako yanakaribia. Lipa TSh " + loan.getMonthlyAmount() + 
                    " kabla ya " + status.getDueDate());
                
                // Knox Guard: Keep unlocked (no action)
            }
            
            // SCENARIO 2: Payment overdue 1-7 days
            else if (status.daysOverdue >= 1 && status.daysOverdue <= 7) {
                
                // Device Owner: Stronger reminder
                deviceOwnerService.sendSoftLock(device.getDeviceId(),
                    "UMECHELEWA SIKU " + status.daysOverdue + "! Lipa sasa.",
                    true); // Block some features
                
                // Knox Guard: Keep unlocked but prepare
            }
            
            // SCENARIO 3: Payment overdue 8-14 days
            else if (status.daysOverdue >= 8 && status.daysOverdue <= 14) {
                
                // Device Owner: Hard lock
                deviceOwnerService.sendHardLock(device.getDeviceId(),
                    "Simu imefungwa. Chelewa siku " + status.daysOverdue);
                
                // Knox Guard: Still keep unlocked (Device Owner handles it)
            }
            
            // SCENARIO 4: Payment overdue 15+ days - ESCALATE TO KNOX
            else if (status.daysOverdue >= 15) {
                
                // Device Owner: Maximum lock
                deviceOwnerService.sendDeactivate(device.getDeviceId(),
                    "Simu imezimwa. Wasiliana na support.");
                
                // Knox Guard: LOCK (hardware-level backup)
                if (device.isSamsung() && isKnoxEnrolled(device.getImei())) {
                    knoxGuardService.lockDevice(
                        device.getImei(),
                        "Malipo yamechelewa zaidi ya siku " + status.daysOverdue + 
                        ". Wasiliana na +255700123456"
                    );
                }
            }
            
            // SCENARIO 5: Payment completed - UNLOCK EVERYTHING
            else if (status.isPaidInFull()) {
                
                // Device Owner: Remove all restrictions
                deviceOwnerService.unlockPermanently(device.getDeviceId());
                
                // Knox Guard: Permanent unlock
                if (device.isSamsung() && isKnoxEnrolled(device.getImei())) {
                    knoxGuardService.unlockDevice(
                        device.getImei(),
                        true // permanent = true
                    );
                }
                
                // Update loan status
                loan.setStatus("COMPLETED");
                loanRepository.save(loan);
            }
        }
    }
    
    /**
     * Manual unlock (for customer service / payment verification)
     */
    public void manualUnlock(String loanId, String reason, String adminUser) {
        
        Loan loan = loanRepository.findById(loanId);
        Device device = loan.getDevice();
        
        // Unlock Device Owner
        deviceOwnerService.unlockTemporarily(device.getDeviceId(), 24); // 24 hours
        
        // Unlock Knox Guard
        if (device.isSamsung() && isKnoxEnrolled(device.getImei())) {
            knoxGuardService.unlockDevice(device.getImei(), false); // temporary
        }
        
        // Log action
        auditLog.record(adminUser, "MANUAL_UNLOCK", loanId, reason);
    }
}
```

**Deliverables:**
- ‚úÖ Payment monitoring updated
- ‚úÖ Knox Guard locks integrated
- ‚úÖ Multi-tier escalation implemented
- ‚úÖ Manual unlock functions added

---

## PHASE 3: ANDROID APP UPDATES (Weeks 5-6)

### 3.1 Add Knox Guard Detection

**Update Your Device Owner App:**

```java
// DeviceInfoCollector.java - Update existing class

public class DeviceInfoCollector {
    
    /**
     * Check if device is Samsung and Knox supported
     */
    public boolean isSamsungKnoxSupported() {
        String manufacturer = Build.MANUFACTURER.toLowerCase();
        
        if (!manufacturer.contains("samsung")) {
            return false;
        }
        
        // Check if Knox is available
        try {
            Class.forName("com.samsung.android.knox.SemPersonaManager");
            return true;
        } catch (ClassNotFoundException e) {
            return false;
        }
    }
    
    /**
     * Check Knox Guard enrollment status
     */
    public KnoxGuardStatus getKnoxGuardStatus() {
        
        if (!isSamsungKnoxSupported()) {
            return KnoxGuardStatus.NOT_SUPPORTED;
        }
        
        try {
            // Use reflection to check Knox Guard state
            Class<?> kgManagerClass = Class.forName("com.samsung.android.knox.lockscreen.KnoxGuardManager");
            Object kgManager = kgManagerClass.getMethod("getInstance", Context.class)
                .invoke(null, context);
            
            Boolean isActive = (Boolean) kgManagerClass.getMethod("isKnoxGuardActive")
                .invoke(kgManager);
            
            if (isActive != null && isActive) {
                return KnoxGuardStatus.ACTIVE;
            } else {
                return KnoxGuardStatus.INACTIVE;
            }
            
        } catch (Exception e) {
            Log.e(TAG, "Error checking Knox Guard status", e);
            return KnoxGuardStatus.UNKNOWN;
        }
    }
    
    /**
     * Add Knox status to heartbeat
     */
    public JSONObject collectDeviceInfo() {
        JSONObject info = new JSONObject();
        
        // Existing data
        info.put("imei", getIMEI());
        info.put("serial", getSerialNumber());
        info.put("model", Build.MODEL);
        // ... other fields ...
        
        // Add Knox information
        info.put("is_samsung", isSamsungKnoxSupported());
        info.put("knox_guard_status", getKnoxGuardStatus().toString());
        
        if (isSamsungKnoxSupported()) {
            info.put("knox_version", getKnoxVersion());
            info.put("knox_guard_enrolled", isKnoxGuardEnrolled());
        }
        
        return info;
    }
}
```

**Deliverables:**
- ‚úÖ Knox detection added
- ‚úÖ Heartbeat includes Knox status
- ‚úÖ Samsung devices identified
- ‚úÖ Knox version reporting

---

### 3.2 Enhanced Lock Screen

**Update Lock Screen to Show Both Systems:**

```java
// LockScreenActivity.java - Update existing activity

public class LockScreenActivity extends AppCompatActivity {
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_lock_screen);
        
        // Existing lock screen setup
        setupKioskMode();
        
        // Add Knox Guard indicator
        showLockStatus();
    }
    
    private void showLockStatus() {
        TextView statusText = findViewById(R.id.lock_status);
        ImageView lockIcon = findViewById(R.id.lock_icon);
        
        DeviceInfoCollector collector = new DeviceInfoCollector(this);
        
        // Check which locking systems are active
        boolean deviceOwnerLocked = isDeviceOwnerLocked();
        boolean knoxGuardLocked = collector.getKnoxGuardStatus() == KnoxGuardStatus.ACTIVE;
        
        if (deviceOwnerLocked && knoxGuardLocked) {
            statusText.setText("Simu imefungwa na Device Protection + Knox Guard");
            lockIcon.setImageResource(R.drawable.ic_lock_double);
        } else if (deviceOwnerLocked) {
            statusText.setText("Simu imefungwa na Device Protection");
            lockIcon.setImageResource(R.drawable.ic_lock_single);
        } else if (knoxGuardLocked) {
            statusText.setText("Simu imefungwa na Knox Guard");
            lockIcon.setImageResource(R.drawable.ic_knox_lock);
        }
        
        // Show message
        String message = getLockMessage();
        TextView messageText = findViewById(R.id.lock_message);
        messageText.setText(message);
        
        // Show support contact
        TextView supportText = findViewById(R.id.support_contact);
        supportText.setText("Wasiliana nasi: +255700123456");
    }
}
```

**New Layout Resource:**

```xml
<!-- res/layout/activity_lock_screen.xml - Enhanced version -->
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="center"
    android:background="#E53935"
    android:padding="24dp">
    
    <!-- Knox Guard Badge (if applicable) -->
    <ImageView
        android:id="@+id/knox_badge"
        android:layout_width="80dp"
        android:layout_height="80dp"
        android:src="@drawable/ic_knox_guard"
        android:visibility="gone"
        android:layout_marginBottom="16dp"/>
    
    <!-- Lock Icon -->
    <ImageView
        android:id="@+id/lock_icon"
        android:layout_width="120dp"
        android:layout_height="120dp"
        android:src="@drawable/ic_lock_double"
        android:tint="@android:color/white"
        android:layout_marginBottom="24dp"/>
    
    <!-- Status Text -->
    <TextView
        android:id="@+id/lock_status"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Simu Imefungwa"
        android:textSize="24sp"
        android:textColor="@android:color/white"
        android:textStyle="bold"
        android:gravity="center"
        android:layout_marginBottom="16dp"/>
    
    <!-- Lock Message -->
    <TextView
        android:id="@+id/lock_message"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Malipo yamechelewa. Lipa ili kufungua simu."
        android:textSize="16sp"
        android:textColor="@android:color/white"
        android:gravity="center"
        android:layout_marginBottom="32dp"/>
    
    <!-- Support Contact -->
    <TextView
        android:id="@+id/support_contact"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Wasiliana nasi: +255700123456"
        android:textSize="14sp"
        android:textColor="@android:color/white"
        android:gravity="center"
        android:layout_marginBottom="16dp"/>
    
    <!-- Emergency Call Button -->
    <Button
        android:id="@+id/emergency_call_btn"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Piga Simu ya Dharura"
        android:textColor="@android:color/white"
        android:background="@drawable/button_emergency"
        android:padding="12dp"/>
        
</LinearLayout>
```

**Deliverables:**
- ‚úÖ Enhanced lock screen UI
- ‚úÖ Knox Guard indicator
- ‚úÖ Dual-lock status display
- ‚úÖ Emergency call support

---

### 3.3 Device Registration Flow Update

**Update Registration to Enroll Knox Guard:**

```java
// RegistrationActivity.java - Update existing activity

public class RegistrationActivity extends AppCompatActivity {
    
    private void registerDevice(String loanNumber, CustomerData customer) {
        
        // Step 1: Collect device info (existing)
        DeviceInfoCollector collector = new DeviceInfoCollector(this);
        JSONObject deviceInfo = collector.collectDeviceInfo();
        
        // Step 2: Register with backend (existing)
        apiClient.registerDevice(loanNumber, deviceInfo, new Callback() {
            @Override
            public void onSuccess(RegistrationResponse response) {
                
                // Save device_id (existing)
                saveDeviceId(response.getDeviceId());
                
                // Step 3: NEW - Enroll in Knox Guard if Samsung
                if (collector.isSamsungKnoxSupported()) {
                    enrollKnoxGuard(response);
                }
                
                // Step 4: Activate Device Owner (existing)
                activateDeviceOwner();
                
                // Step 5: Start heartbeat (existing)
                startHeartbeatService();
                
                // Step 6: Navigate to main activity
                navigateToMainActivity();
            }
            
            @Override
            public void onError(String error) {
                showError(error);
            }
        });
    }
    
    /**
     * NEW METHOD: Enroll device in Knox Guard during registration
     */
    private void enrollKnoxGuard(RegistrationResponse response) {
        
        // Show progress
        showProgress("Kuandikisha Knox Guard...");
        
        // Backend will handle actual Knox API call
        // This just triggers the process
        apiClient.enrollKnoxGuard(response.getDeviceId(), new Callback() {
            @Override
            public void onSuccess(KnoxEnrollmentResponse knoxResponse) {
                Log.i(TAG, "Knox Guard enrolled successfully");
                
                // Save Knox enrollment status
                SharedPreferences prefs = getSharedPreferences("device_prefs", MODE_PRIVATE);
                prefs.edit()
                    .putBoolean("knox_guard_enrolled", true)
                    .putString("knox_enrollment_id", knoxResponse.getEnrollmentId())
                    .putLong("knox_enrollment_time", System.currentTimeMillis())
                    .apply();
                
                hideProgress();
            }
            
            @Override
            public void onError(String error) {
                // Knox enrollment failed, but continue with Device Owner
                Log.w(TAG, "Knox Guard enrollment failed: " + error);
                
                // Don't block registration - Device Owner still works
                hideProgress();
            }
        });
    }
}
```

**Backend Endpoint:**

```java
// DeviceController.java - Add new endpoint

@RestController
@RequestMapping("/api/devices")
public class DeviceController {
    
    @Autowired
    private KnoxGuardService knoxGuardService;
    
    /**
     * NEW ENDPOINT: Enroll device in Knox Guard
     */
    @PostMapping("/{deviceId}/knox-enroll")
    public ResponseEntity<KnoxEnrollmentResponse> enrollKnoxGuard(
        @PathVariable String deviceId
    ) {
        
        Device device = deviceRepository.findByDeviceId(deviceId);
        
        if (device == null) {
            return ResponseEntity.notFound().build();
        }
        
        // Check if Samsung device
        if (!device.getManufacturer().equalsIgnoreCase("Samsung")) {
            return ResponseEntity.badRequest()
                .body(new KnoxEnrollmentResponse(
                    false, 
                    "Device is not Samsung - Knox Guard not supported"
                ));
        }
        
        try {
            // Enroll in Knox Guard
            KnoxEnrollmentResult result = knoxGuardService.enrollDevice(
                device.getImei(),
                device.getSerialNumber()
            );
            
            // Update device record
            device.setKnoxEnrolled(true);
            device.setKnoxEnrollmentId(result.getEnrollmentId());
            deviceRepository.save(device);
            
            return ResponseEntity.ok(new KnoxEnrollmentResponse(
                true,
                result.getEnrollmentId(),
                "Knox Guard enrolled successfully"
            ));
            
        } catch (Exception e) {
            Log.error("Knox enrollment failed for device " + deviceId, e);
            
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new KnoxEnrollmentResponse(
                    false,
                    "Knox enrollment failed: " + e.getMessage()
                ));
        }
    }
}
```

**Deliverables:**
- ‚úÖ Registration flow updated
- ‚úÖ Knox enrollment integrated
- ‚úÖ Backend endpoint created
- ‚úÖ Error handling implemented

---

## PHASE 4: TESTING & VALIDATION (Weeks 7-8)

### 4.1 Test Scenarios

**Execute These Tests:**

```
TEST 1: Samsung Device Registration
- Register Samsung device with loan
- Verify Knox Guard enrolled
- Verify Device Owner activated
- Check heartbeat includes Knox status

TEST 2: Non-Samsung Device Registration
- Register Tecno/Infinix device
- Verify Device Owner works
- Confirm Knox Guard skipped (not supported)
- Check no errors in logs

TEST 3: Payment Overdue ‚Üí Lock
- Simulate 15 days overdue
- Verify Device Owner locks device
- Verify Knox Guard locks device
- Test emergency call still works

TEST 4: Payment Made ‚Üí Unlock
- Simulate payment received
- Verify Device Owner unlocks
- Verify Knox Guard unlocks
- Test device fully functional

TEST 5: Factory Reset Attempt
- Lock device (both systems)
- Attempt factory reset via recovery
- Verify Device Owner blocks it
- Verify Knox Guard survives reset
- Verify device re-locks after reboot

TEST 6: Bootloader Unlock Attempt
- Enable Developer Options (should fail)
- Enable OEM Unlock (should fail)
- Reboot to bootloader
- Attempt unlock (should fail or be detected)

TEST 7: Full Payment ‚Üí Permanent Unlock
- Complete all payments
- Verify Device Owner removes restrictions
- Verify Knox Guard unenrolls
- Verify device is normal Samsung phone
- Check Knox Guard badge removed

TEST 8: Cash Sale (No Loan)
- Sell device for cash
- Don't enroll Knox Guard
- Don't activate Device Owner locks
- Verify device works normally
```

**Test Matrix:**

| Test Case | Device Owner | Knox Guard | Expected Result |
|-----------|-------------|------------|-----------------|
| Samsung + Loan | ‚úÖ Active | ‚úÖ Enrolled | Double protection |
| Samsung + Cash | ‚úÖ Inactive | ‚ùå Not enrolled | Normal phone |
| Non-Samsung + Loan | ‚úÖ Active | ‚ùå Not supported | Device Owner only |
| Payment Late 15d | üîí Locked | üîí Locked | Both systems lock |
| Factory Reset | üîí Blocked | üîí Survives | Device stays locked |
| Full Payment | üîì Unlocked | üîì Unenrolled | Completely free |

**Deliverables:**
- ‚úÖ All test scenarios passed
- ‚úÖ Test results documented
- ‚úÖ Bugs identified and fixed
- ‚úÖ Performance validated

---

### 4.2 Pilot Deployment

**Start Small:**

```
Week 7: 
- Deploy to 10 test customers (friends/family/employees)
- Mix of Samsung and non-Samsung devices
- Monitor closely for issues

Week 8:
- Deploy to 50 real customers
- Track payment behavior
- Monitor lock/unlock operations
- Gather user feedback
```

**Metrics to Track:**

```
Device Metrics:
- Registration success rate
- Knox enrollment success rate
- Heartbeat reliability
- Lock/unlock response time

Business Metrics:
- Payment compliance rate
- Lock event frequency
- Unlock request frequency
- Customer support calls

Technical Metrics:
- API error rate
- Knox API latency
- Device Owner command delivery
- Battery impact
```

**Deliverables:**
- ‚úÖ 10 pilot devices deployed
- ‚úÖ 50 production devices deployed
- ‚úÖ Metrics dashboard created
- ‚úÖ Issues identified and resolved

---

## PHASE 5: PRODUCTION ROLLOUT (Weeks 9-12)

### 5.1 Shop Owner Portal Update

**Add Knox Management Features:**

```java
// ShopOwnerPortal.jsx - Add Knox status display

function DeviceManagementDashboard() {
    
    const [devices, setDevices] = useState([]);
    
    useEffect(() => {
        fetchMyDevices();
    }, []);
    
    return (
        <div className="dashboard">
            <h2>My Devices</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>IMEI</th>
                        <th>Model</th>
                        <th>Customer</th>
                        <th>Payment Status</th>
                        <th>Device Owner</th>
                        <th>Knox Guard</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {devices.map(device => (
                        <tr key={device.imei}>
                            <td>{device.imei}</td>
                            <td>{device.model}</td>
                            <td>{device.customerName}</td>
                            <td>
                                <span className={`status ${device.paymentStatus}`}>
                                    {device.paymentStatus}
                                </span>
                            </td>
                            <td>
                                {device.deviceOwnerActive ? 
                                    <span className="badge green">Active</span> :
                                    <span className="badge gray">Inactive</span>
                                }
                            </td>
                            <td>
                                {device.knoxEnrolled ? 
                                    <span className="badge blue">Enrolled</span> :
                                    <span className="badge gray">N/A</span>
                                }
                            </td>
                            <td>
                                <button onClick={() => viewDevice(device.id)}>
                                    View
                                </button>
                                {device.locked && (
                                    <button onClick={() => requestUnlock(device.id)}>
                                        Request Unlock
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}
```

**Deliverables:**
- ‚úÖ Shop portal updated
- ‚úÖ Knox status visible
- ‚úÖ Unlock requests integrated
- ‚úÖ Training materials created

---

### 5.2 Customer Support Training

**Train Your Support Team:**

```
Support Scenarios:

SCENARIO 1: Customer Can't Unlock Phone
Q: "My phone is locked, how do I unlock it?"
A: 
1. Check payment status in system
2. If payment received, unlock remotely
3. If not paid, explain overdue amount
4. Process payment and unlock

SCENARIO 2: Factory Reset Didn't Work
Q: "I tried factory reset but phone still locked"
A:
1. Explain this is Knox Guard protection
2. Factory reset cannot remove Knox Guard
3. Only payment completion unlocks device
4. Offer payment plan options

SCENARIO 3: Knox Guard vs Device Owner
Q: "Why does it say Knox Guard AND Device Protection?"
A:
1. Explain double protection for Samsung
2. Both systems work together
3. Provides maximum security
4. Ensures device stays protected

SCENARIO 4: Permanent Unlock After Full Payment
Q: "I paid everything, when will my phone be normal?"
A:
1. Verify full payment received
2. Process permanent unlock
3. Takes 5-10 minutes to sync
4. Restart phone after unlock
5. Knox Guard will be removed
```

**Support Scripts:**

```
SCRIPT 1: Payment Late Unlock
"I see your payment is late by [X] days. Your phone has been locked 
for security. I can unlock it once we receive payment of [AMOUNT]. 
Would you like to make a payment now?"

SCRIPT 2: Full Payment Unlock
"Congratulations! You've completed all payments. I'm processing your 
permanent unlock now. Your phone will be completely yours with no 
restrictions. This takes about 5-10 minutes. Please restart your 
phone after you receive the unlock notification."

SCRIPT 3: Technical Issue
"I see there's a technical issue with your device. Let me check with 
our technical team. Can you provide your phone's IMEI number? It's 
in Settings > About Phone > IMEI."
```

**Deliverables:**
- ‚úÖ Support team trained
- ‚úÖ Scripts documented
- ‚úÖ FAQ created
- ‚úÖ Escalation process defined

---

### 5.3 Scale to Production

**Gradual Rollout:**

```
Week 9: 100 devices (Samsung focus)
Week 10: 300 devices (Mix Samsung + others)
Week 11: 500 devices
Week 12: 1,000+ devices (Full production)
```

**Monitoring Dashboard:**

```java
// Create monitoring dashboard showing:

1. Device Health:
   - Total devices enrolled
   - Knox Guard devices
   - Device Owner only devices
   - Devices online/offline
   - Locked devices count

2. Knox Guard Metrics:
   - Enrollment success rate
   - Lock operations today
   - Unlock operations today
   - API error rate
   - Average response time

3. Business Metrics:
   - Devices on-time payment
   - Devices late payment
   - Revenue collected
   - Lock prevention rate
   - Customer satisfaction

4. Alerts:
   - Knox API errors
   - Enrollment failures
   - Unlock failures
   - High lock volumes
   - Payment processing issues
```

**Deliverables:**
- ‚úÖ 1,000+ devices deployed
- ‚úÖ Monitoring active
- ‚úÖ Support team ready
- ‚úÖ Business metrics tracking

---

## PHASE 6: OPTIMIZATION & ADVANCED FEATURES (Ongoing)

### 6.1 Performance Optimization

**Optimize Knox API Calls:**

```java
// Implement batch operations for better performance

public class KnoxGuardBatchService {
    
    /**
     * Bulk lock devices (process overdue payments)
     */
    public BatchResult bulkLockDevices(List<String> imeiList, String reason) {
        
        // Knox Guard supports bulk operations
        JSONArray devices = new JSONArray();
        
        for (String imei : imeiList) {
            String enrollmentId = getKnoxEnrollmentId(imei);
            devices.put(new JSONObject()
                .put("enrollmentId", enrollmentId)
                .put("message", reason)
            );
        }
        
        Request request = new Request.Builder()
            .url(KNOX_API_BASE + "devices/bulk-lock")
            .post(RequestBody.create(
                MediaType.parse("application/json"),
                new JSONObject().put("devices", devices).toString()
            ))
            .build();
            
        Response response = client.newCall(request).execute();
        return parseBatchResult(response);
    }
    
    /**
     * Bulk unlock devices (payments received)
     */
    public BatchResult bulkUnlockDevices(List<String> imeiList) {
        // Similar implementation
    }
}
```

**Deliverables:**
- ‚úÖ Batch operations implemented
- ‚úÖ API calls reduced by 80%
- ‚úÖ Response time improved
- ‚úÖ Cost optimized

---

### 6.2 Advanced Features

**Add These Over Time:**

```
1. PREDICTIVE LOCKING
   - Machine learning to predict default risk
   - Pre-emptive soft locks before due date
   - Graduated lock levels based on risk score

2. GEOFENCING
   - Alert if device leaves Tanzania
   - Auto-lock if device goes to known fraud area
   - Location-based payment reminders

3. CUSTOMER SELF-SERVICE
   - Mobile app for customers
   - Payment history viewing
   - Temporary unlock requests (24h grace)
   - Payment scheduling

4. MULTI-DEVICE CUSTOMERS
   - Track customers with multiple devices
   - Family plan discounts
   - Cross-device payment enforcement

5. INSURANCE INTEGRATION
   - Device damage reporting
   - Theft reporting and blacklisting
   - Insurance claim processing
```

**Deliverables:**
- ‚úÖ Feature roadmap defined
- ‚úÖ Priorities set
- ‚úÖ Development scheduled
- ‚úÖ Customer feedback incorporated

---

# üìä SUCCESS METRICS

## By End of Rollout (3-6 months):

```
Technical Metrics:
‚úÖ 1,000+ devices enrolled
‚úÖ 95%+ Knox enrollment success rate
‚úÖ 99.9% heartbeat reliability
‚úÖ <2 second lock/unlock response time
‚úÖ <1% API error rate

Business Metrics:
‚úÖ 20% reduction in default rate
‚úÖ 90%+ on-time payment rate
‚úÖ <5% customer support calls
‚úÖ 95%+ customer satisfaction
‚úÖ Break-even on Knox Guard costs

Cost Metrics:
‚úÖ Knox Guard: $3,650/year for 1,000 devices
‚úÖ Development: $10,000-20,000 one-time
‚úÖ Maintenance: $2,000/month
‚úÖ ROI: Positive within 6 months
```

---

# üí∞ COST BREAKDOWN

```
INITIAL COSTS:
- Knox Guard registration: $0 (free)
- Development time: 8-12 weeks √ó $1,500/week = $12,000-18,000
- Test devices: 5 √ó $150 = $750
- Training materials: $500
TOTAL INITIAL: ~$13,000-19,000

MONTHLY COSTS (1,000 devices):
- Knox Guard licensing: $300/month ($0.01/device/day)
- Backend infrastructure: $200/month
- Support staff: $1,500/month
TOTAL MONTHLY: ~$2,000/month

ANNUAL COSTS:
- Knox Guard: $3,650/year
- Infrastructure: $2,400/year
- Support: $18,000/year
- Maintenance & updates: $5,000/year
TOTAL ANNUAL: ~$29,000/year

COST PER DEVICE:
- One-time: $13-19 (development amortized)
- Ongoing: $29/year = $2.42/month per device
```

**ROI Calculation:**

```
If your default rate drops from 15% to 10% (5% improvement):
- 1,000 devices √ó $300 average loan = $300,000 in loans
- 5% improvement = $15,000 saved annually
- Cost = $29,000/year
- Need 2,000 devices to break even
- At 3,000+ devices = highly profitable
```

---

# üìã IMPLEMENTATION CHECKLIST

## Pre-Implementation:
- [ ] Samsung Knox Guard account registered
- [ ] API credentials obtained
- [ ] Test devices purchased (3-5 Samsung phones)
- [ ] Development environment ready
- [ ] Backend infrastructure prepared

## Phase 1 (Weeks 1-2):
- [ ] Knox Guard API integration designed
- [ ] Database schema updated
- [ ] Test API calls successful
- [ ] Documentation reviewed

## Phase 2 (Weeks 3-4):
- [ ] Backend API service implemented
- [ ] Payment integration updated
- [ ] Multi-tier lock logic added
- [ ] Manual unlock functions created

## Phase 3 (Weeks 5-6):
- [ ] Android app updated with Knox detection
- [ ] Registration flow modified
- [ ] Lock screen enhanced
- [ ] Knox status reporting added

## Phase 4 (Weeks 7-8):
- [ ] All test scenarios passed
- [ ] 10 pilot devices deployed
- [ ] 50 production devices deployed
- [ ] Metrics dashboard created

## Phase 5 (Weeks 9-12):
- [ ] Shop owner portal updated
- [ ] Support team trained
- [ ] 1,000+ devices deployed
- [ ] Monitoring active

## Phase 6 (Ongoing):
- [ ] Performance optimized
- [ ] Advanced features added
- [ ] Customer feedback incorporated
- [ ] Continuous improvement

---

# üéØ FINAL RECOMMENDATIONS

## Do This:

1. **Start with Samsung Focus**
   - Samsung phones have best Knox Guard support
   - Higher margins justify Knox Guard cost
   - Better customer experience

2. **Dual-System Strategy**
   - Samsung = Knox Guard + Device Owner
   - Other brands = Device Owner only
   - Maximum flexibility

3. **Gradual Rollout**
   - Test with 10 devices first
   - Scale to 50, then 100, then 1,000+
   - Learn and adjust along the way

4. **Monitor Closely**
   - Track all metrics from day 1
   - Adjust based on data
   - Optimize continuously

## Don't Do This:

1. **Don't Rush**
   - Take time to test properly
   - Don't skip pilot phase
   - Don't deploy to 1,000 devices immediately

2. **Don't Ignore Non-Samsung**
   - Device Owner still works great
   - Many customers prefer Tecno/Infinix
   - Don't limit yourself to Samsung only

3. **Don't Forget Support**
   - Train support team properly
   - Create good documentation
   - Have escalation process ready

4. **Don't Over-Lock**
   - Be fair with lock policies
   - Give grace periods
   - Focus on communication first

---

# üìû NEXT STEPS

Ready to get started? Here's what to do **this week**:

## Week 1 Actions:

1. **Monday**: Register for Samsung Knox Guard account
2. **Tuesday**: Order 3 Samsung test devices (A05/A13 models)
3. **Wednesday**: Review Knox Guard API documentation
4. **Thursday**: Plan backend architecture updates
5. **Friday**: Create project timeline and assign tasks

## Need Help?

Contact these resources:
- Samsung Knox Guard Support: knoxguard@samsung.com
- Samsung Developer Portal: https://developer.samsung.com/
- Knox Guard Documentation: https://docs.samsungknox.com/

---

**Good luck with your implementation! You're building the next Watu Simu! üöÄ**

---

*Document Version: 1.0*  
*Last Updated: February 2026*  
*Author: Technical Consultant*
