# 16.0 DEACTIVATION

This document describes **Device Owner deactivation**: when it is requested, how it is performed, and what happens to the device and app. Deactivation returns the device to a **normal, unmanaged state** (like any other consumer phone).

---

## Overview

| Aspect | Description |
|--------|-------------|
| **Purpose** | Remove Device Owner and all management so the device is no longer locked or restricted (e.g. loan paid off, asset returned). |
| **Trigger** | **Server** (heartbeat response: `deactivate_requested` / `deactivation.status == "requested"`) or **user** (MainActivity “REMOVE DEVICE OWNER” button). |
| **Result** | App loses Device Owner and Device Admin; all restrictions, lock state, and managed UI are cleared; all app services are stopped; device behaves like a normal phone. |

---

## When deactivation is requested

### 1. From the server (heartbeat)

- **HeartbeatService** and **HeartbeatWorker** check **`response.isDeactivationRequested()`** (e.g. `deactivateRequested == true` or `deactivation.status == "requested"`).
- If true:
  - Heartbeat skips further work if deactivation is already in progress.
  - **DeviceOwnerDeactivationManager.deactivateDeviceOwner()** is invoked (from HeartbeatService or HeartbeatWorker).
- **DeactivationHandler** (optional layer) can coordinate with the server and call **DeviceOwnerDeactivationManager** when the backend sends a deactivation request.

### 2. From the user (MainActivity)

- **MainActivity** (ui.activities.main) shows a “REMOVE DEVICE OWNER (NORMAL STATE)” button when the app is Device Owner.
- On tap it calls **DeviceOwnerDeactivationManager(context).deactivateDeviceOwner()** (via coroutine) and shows success/failure with a Toast.

---

## Deactivation flow (DeviceOwnerDeactivationManager)

**DeviceOwnerDeactivationManager** (`deactivation/DeviceOwnerDeactivationManager.kt`) runs a **phased cleanup** so no traces of lockdown remain.

| Phase | Action |
|-------|--------|
| **0** | Verify Device Owner / Admin status. If neither active, treat as already deactivated and return Success. |
| **1** | Cancel all WorkManager work (Heartbeat, OfflineSync, RestrictionEnforcement, UpdateCheck, etc.). **Stop all app services** (SoftLockMonitor, SoftLockOverlay, SecurityMonitor, RemoteManagement, FirmwareSecurityMonitor, LocalDataServer). |
| **2** | **Clear all user restrictions** (factory reset, safe boot, add/remove user, USB, debugging, WiFi/Bluetooth config, install/uninstall apps, etc.). |
| **3** | **Reset global policies**: lock task packages, status bar, keyguard, camera, organization name, support messages, lock screen info; re-enable ADB and development settings. |
| **4** | **Unsuspend** all applications (clear setPackagesSuspended). |
| **5** | **Clear lock and control state**: clear SharedPreferences for `control_prefs`, `device_owner_prefs`, `device_owner_config`, `device_lock`. |
| **6** | **Remove Device Owner and Admin**: **clearDeviceOwnerApp()** first (while still Device Owner), then **removeActiveAdmin()**. Order is critical so the device no longer “belongs to organization”. |
| **7** | **Clear app data** (prefs, etc.) so no managed state remains. |
| **8** | **Verify**: confirm app is no longer Device Owner and no longer Admin. If still active, force **clearDeviceOwnerApp** / **removeActiveAdmin**. |
| **9** | Show app icon (user can uninstall like any app). Optionally **skip** self-uninstall so the user sees no dialog; app remains installed but inert. |

After deactivation, the device is a normal phone: no Device Owner, no restrictions, no lock screens from the app, no managed branding.

---

## Main classes

| Class | Role |
|-------|------|
| **DeviceOwnerDeactivationManager** | Runs the full deactivation sequence (phases 0–9). Entry: **deactivateDeviceOwner()** (suspend function). Returns **DeactivationResult.Success** or **DeactivationResult.Failure(error)**. |
| **DeactivationHandler** | High-level handler for server-triggered deactivation: calls **DeviceOwnerDeactivationManager**, can send confirmation to backend (with retries). |
| **DeactivationResult** | Sealed type: **Success** or **Failure(error: String)**. |

---

## Services stopped during deactivation

All of the following are stopped so no management or lock services keep running:

- **SoftLockMonitorService**
- **SoftLockOverlayService**
- **SecurityMonitorService**
- **RemoteManagementService**
- **FirmwareSecurityMonitorService**
- **LocalDataServerService**

WorkManager work (heartbeat, sync, restriction enforcement, update check) is cancelled so no background work continues.

---

## Heartbeat and deactivation

- **HeartbeatService** and **HeartbeatWorker** treat **isDeactivationRequested()** as **priority 1**: before applying lock or other commands, they check for deactivation and, if requested, run **DeviceOwnerDeactivationManager.deactivateDeviceOwner()**.
- While deactivation is in progress, heartbeat can **skip** sending (to avoid redundant work and to respond quickly to the backend).
- **LockScreenManager** / **LockScreenStrategy**: when the server sends a “deactivation” lock type, the UI can show a “deactivation in progress” or similar state; the actual removal of Device Owner is done by **DeviceOwnerDeactivationManager**.

---

## User-visible behavior

- **Before**: Device is managed (restrictions, possible lock screen, “Managed by organization”).
- **After**: Device behaves like a normal phone. App icon is visible; user can open the app (it is inert) or uninstall from Settings. No Device Owner, no FRP from this app, no lock or restriction from this app.

---

## Summary

- **Deactivation** = full removal of Device Owner and Admin + cleanup of restrictions, lock state, and services.
- **Triggered** by heartbeat (`isDeactivationRequested()`) or by the user in MainActivity.
- **Implemented** in **DeviceOwnerDeactivationManager** (phased flow); **DeactivationHandler** can wrap this for server-driven flows.
- **Result**: device returns to a normal, unmanaged state; app no longer has Device Owner privilege.
