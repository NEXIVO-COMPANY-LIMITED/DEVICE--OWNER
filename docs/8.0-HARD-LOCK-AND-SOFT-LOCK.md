# 8.0 HARD LOCK AND SOFT LOCK

This document describes the two lock modes: **hard lock** (full kiosk block) and **soft lock** (dismissible reminder overlay).

---

## Overview

| Lock type | Purpose | User can dismiss? | Persists across reboot? |
|-----------|----------|-------------------|-------------------------|
| **Hard lock** | Payment overdue, tamper, or server command | No | Yes |
| **Soft lock** | Payment reminder (e.g. 1 day before due), SIM change warning | Yes (after acknowledging) | No |

Lock state and reason are stored in SharedPreferences (`control_prefs`) and optionally in device-protected storage so that on boot (including before user unlocks) the app can show the correct screen.

---

## Hard Lock

### When it is used

- **Server**: Heartbeat response says device should be locked (`is_locked` / `content.isLocked` / `management.managementStatus == "locked"`).
- **Tamper**: Critical tamper (bootloader unlock, developer options, USB debug, root, SIM change, Device Owner removal, package removal) â†’ **EnhancedAntiTamperResponse** applies hard lock immediately, then notifies server.
- **Boot**: **TamperBootChecker** detects violation on boot â†’ hard lock + tamper report.

### How it works

1. **RemoteDeviceControlManager.applyHardLock(reason, forceRestart, forceFromServerOrMismatch, tamperType)**  
   - Sets lock state to `LOCK_HARD` in SharedPreferences and in **device-protected storage** (so BootReceiver can read it before user unlocks).  
   - Saves reason and timestamp.  
   - Calls **HardLockManager.applyHardLock()** and/or starts **HardLockActivity**.

2. **HardLockManager**  
   - Saves lock state (e.g. `device_locks`: lock_type, lock_reason, lock_timestamp, lock_source).  
   - Calls **DevicePolicyManager.lockNow()** so the device locks immediately.  
   - Starts the full-screen lock activity (**HardLockActivity**) that cannot be dismissed (kiosk mode).  
   - Lock state is persisted so that after reboot, **BootReceiver** reads it and re-shows **HardLockActivity** if still hard locked.

3. **HardLockActivity**  
   - Full-screen, singleTask, excludeFromRecents.  
   - Shows lock reason, recommendation, and (if configured) payment/contact info.  
   - Back and recent-apps do not dismiss it; user must resolve with server (e.g. payment) to get unlock.

### Unlock

- Server sends unlock (heartbeat or management API); app clears hard lock state and stops showing **HardLockActivity**. Unlock can also come from deactivation when the loan is complete.

---

## Soft Lock

### When it is used

- **Payment reminder**: Heartbeat returns e.g. `next_payment` (e.g. 1 day before due) â†’ app shows a **reminder overlay** so the user can pay in time.  
- **SIM change**: **SIMChangeDetector** detects SIM change â†’ show **SIMChangeOverlayActivity** or **SoftLockOverlayService** with SIM warning; user taps â€œContinueâ€ to dismiss.  
- **SoftLockType** enum: `PAYMENT_REMINDER`, `SIM_CHANGE` (title, message, button text).

### How it works

1. **SoftLockOverlayService**  
   - Foreground service that shows a full-screen Compose overlay.  
   - **startOverlay(context, reason, triggerAction, nextPaymentDate, organizationName)** â€” starts overlay with reason and optional next payment date / org name.  
   - **stopOverlay(context)** â€” dismisses overlay.  
   - User taps â€œI UNDERSTANDâ€ / â€œCONTINUEâ€ â†’ overlay is closed; device remains usable (no kiosk).

2. **SoftLockMonitorService**  
   - Monitors when to show the soft lock (e.g. from heartbeat data or local rules) and coordinates with **SoftLockOverlayService**.

3. **Soft lock types** (`SoftLockType`)  
   - **PAYMENT_REMINDER**: Payment due soon; button â€œI UNDERSTANDâ€.  
   - **SIM_CHANGE**: Unauthorized SIM detected; button â€œCONTINUEâ€. Event is logged; user can continue using the device after acknowledging.

### Difference from hard lock

- Soft lock is **dismissible**; hard lock is not.  
- Soft lock does **not** call `lockNow()` or block the whole device; it is an overlay only.  
- Hard lock persists across reboot; soft lock is session-only (no persistent â€œsoft lockedâ€ state after reboot).

---

## Lock state storage

- **RemoteDeviceControlManager** uses SharedPreferences `control_prefs`: `state` (unlocked / soft_lock / hard_lock), `reason`, `lock_timestamp`, etc.  
- For **boot**: same keys are written to **device-protected storage** via `createDeviceProtectedStorageContext()` so **BootReceiver** can read them on `LOCKED_BOOT_COMPLETED`.  
- **HardLockManager** uses `device_locks` for lock_type, lock_reason, lock_timestamp, lock_source.  
- **LockStateRecordEntity** / **LockStateRecordDao** in **DeviceOwnerDatabase** can store lock history for auditing.

---

## Restriction policy

- **Block user (keyboard/touch/kiosk)** only when: (1) server sends hard lock, or (2) critical tamper.  
- **Do not block** during registration or after registration until the server says lock; soft lock never blocks, only reminds.  
- **applyRestrictionsForSetupOnly()** is used so keyboard and touch work until registration is complete and server instructs lock.

---

## Summary

| Topic | Hard lock | Soft lock |
|-------|-----------|-----------|
| Trigger | Server lock, tamper, boot violation | Payment reminder, SIM change |
| UI | HardLockActivity (kiosk) | SoftLockOverlayService overlay |
| Dismissible | No | Yes |
| Persists after reboot | Yes | No |
| DevicePolicyManager.lockNow() | Yes | No |

Related: [9.0 Device Tamper](9.0-DEVICE-TAMPER.md), [7.0 Device Heartbeat](7.0-DEVICE-HEARTBEAT.md), [13.0 Services](13.0-SERVICES.md).


