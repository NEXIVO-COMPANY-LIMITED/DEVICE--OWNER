# 7.0 Device Heartbeat System

Complete guide to understanding how the Device Heartbeat system works and why it might fail.

---

## Overview

The **Heartbeat** is the core monitoring system that keeps devices connected to the backend. Every 30 seconds, the device sends its status to the server, and the server responds with commands (lock, deactivate, etc.).

**Without heartbeat, the device is unmanaged and cannot be controlled remotely.**

---

## How Heartbeat Works

### Architecture

```
Device (Android App)
    â†“
HeartbeatService.kt (every 30 seconds)
    â†“
SecurityMonitorService (Foreground Service)
    â†“
ApiClient (Retrofit)
    â†“
Backend: POST /api/devices/{device_id}/data/
    â†“
Server Response (lock, deactivate, next_payment, etc.)
    â†“
Device processes response
```

---

## Part 1: Backend Heartbeat Reception

### Endpoint

```
POST /api/devices/{device_id}/data/
```

**Example:**
```
POST /api/devices/DEV-B5AF7F0BEDEB/data/
```

### Security

The backend requires an API key header:

```
Header: X-Device-Api-Key: <DEVICE_AGENT_API_KEY>
```

This key must match the one in your `.env` file on the server:

```
DEVICE_AGENT_API_KEY=your-secret-key-here
```

And in your Android app (`ApiConstants.kt`):

```kotlin
const val DEVICE_AGENT_API_KEY = "your-secret-key-here"
```

**âš ï¸ If keys don't match â†’ 403 Forbidden error â†’ Heartbeat fails**

### Backend Logic

When the backend receives heartbeat data:

#### 1. Baseline Comparison
The server compares current device data with data from registration:

```
Current Data:
- RAM: 4GB
- IMEI: 123456789
- Storage: 32GB
- Security Status: ROOTED

vs

Registration Data:
- RAM: 4GB
- IMEI: 123456789
- Storage: 32GB
- Security Status: NORMAL
```

#### 2. Auto-Lock Decision
If there's a significant difference:

```
IF IMEI changed â†’ is_locked = true
IF Device rooted â†’ is_locked = true
IF RAM decreased significantly â†’ is_locked = true
IF SIM changed â†’ is_locked = true
```

#### 3. Server Response

The backend returns JSON:

```json
{
  "device_id": "DEV-B5AF7F0BEDEB",
  "status": "active",
  "is_locked": false,
  "next_payment": "2026-02-28",
  "deactivation_requested": false,
  "tamper_indicators": [],
  "commands": []
}
```

---

## Part 2: Android Device Heartbeat Sending

### HeartbeatService.kt

The Android app sends heartbeat using `Heartb

