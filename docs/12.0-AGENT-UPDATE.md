# 12.0 AGENT UPDATE (AUTO-UPDATE)

This document describes **automatic app updates** from GitHub Releases: how the app checks for new versions, downloads the APK, and installs silently using Device Owner privileges.

---

## Overview

The Device Owner app can **update itself** without user interaction by:

1. Fetching the latest release from a **GitHub** repository.  
2. Downloading the release APK.  
3. Installing it silently via **PackageInstaller** (Device Owner / device admin can install packages without user approval).  
4. Optionally notifying the user (e.g. “Update available”, “Downloading”, “App up to date”).

---

## Components

### UpdateConfig

**Class**: `com.example.deviceowner.update.UpdateConfig`

| Constant | Purpose |
|----------|---------|
| GITHUB_OWNER | GitHub org/user (e.g. NEXIVO-COMPANY-LIMITED) |
| GITHUB_REPO | Repository name (e.g. DEVICE--OWNER) |
| GITHUB_API_URL | `https://api.github.com/repos/{owner}/{repo}/releases/latest` |
| APK_FILE_NAME | Asset name in release (e.g. app-release.apk) |
| UPDATE_CHECK_INTERVAL_HOURS | Interval for periodic check (e.g. 6) |
| INITIAL_DELAY_MINUTES | Delay before first check (e.g. 30) |
| WORK_NAME | WorkManager unique work name (e.g. github_update_check) |
| NOTIFICATION_CHANNEL_ID / NOTIFICATION_ID | For update notifications |
| AUTO_INSTALL_UPDATES | Whether to install automatically when update found |
| REQUIRE_WIFI / REQUIRE_CHARGING | Optional constraints |
| ALLOW_DOWNGRADE | Whether to allow installing older version |
| ACTION_INSTALL_COMPLETE | Broadcast action when install finishes |

### GitHubUpdateManager

**Class**: `com.example.deviceowner.update.GitHubUpdateManager`

- **checkAndUpdate()**:  
  - Gets current app version.  
  - Fetches latest release from GitHub API.  
  - Compares versions; if update available → **downloadAndInstallUpdate(latestRelease)**.  
  - Shows notifications: “Update available”, “Downloading”, “App up to date”, or “Update error”.  
- **fetchLatestRelease()**: HTTP GET to `UpdateConfig.GITHUB_API_URL`, parses JSON.  
- **parseGitHubRelease(json)**: Extracts version tag and APK download URL from release assets.  
- **downloadAndInstallUpdate(release)**: Downloads APK to a file, then uses **PackageInstaller** to install (silent when Device Owner).  
- Uses **UpdateReceiver** for install-complete callback (e.g. ACTION_INSTALL_COMPLETE).

### UpdateScheduler

- Schedules **periodic** update checks (e.g. via WorkManager) using **UpdateCheckWorker**.  
- **UpdateScheduler.schedulePeriodicChecks(context)** is called from **DeviceOwnerApplication** when the app is Device Owner.

### UpdateCheckWorker

- WorkManager worker that runs **GitHubUpdateManager.checkAndUpdate()** when the periodic work runs.

### UpdateReceiver

- Broadcast receiver for **ACTION_INSTALL_COMPLETE**.  
- Handles post-install logic (e.g. cancel notification, log success).

---

## Flow

1. **DeviceOwnerApplication.onCreate()**: If Device Owner → **UpdateScheduler.schedulePeriodicChecks(this)** and, after a short delay, **GitHubUpdateManager.checkAndUpdate()** (startup check).  
2. **UpdateCheckWorker** (periodic): Runs **checkAndUpdate()** at the configured interval.  
3. **checkAndUpdate()**: GET latest release → compare version → if newer, download APK → install via PackageInstaller → notify user.  
4. On install complete, **UpdateReceiver** receives the broadcast and performs any cleanup.

---

## Permissions

- **REQUEST_INSTALL_PACKAGES**, **INSTALL_PACKAGES** (protected), **DELETE_PACKAGES** (protected) for silent install/uninstall when Device Owner.  
- **INTERNET** for GitHub API and APK download.  
- **POST_NOTIFICATIONS** (Android 13+) for update progress notifications.

---

## Summary

| Item | Description |
|------|-------------|
| Source | GitHub Releases (configurable owner/repo) |
| Trigger | Startup check + periodic WorkManager |
| Install | PackageInstaller (silent when Device Owner) |
| Config | UpdateConfig (URL, interval, notification, constraints) |

Related: [1.0 Device Owner Overview](1.0-DEVICE-OWNER-OVERVIEW.md), [13.0 Services](13.0-SERVICES.md).
